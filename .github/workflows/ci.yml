name: CI Pipeline

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  ci-test:
    name: Build & Test Docker Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Build Docker image
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          tags: lily-designer-studio:latest
          load: true

      # Start Postgres
      - name: Start PostgreSQL
        run: |
          docker network create lily-net || true

          docker run -d --name lily-db --network lily-net \
            -e POSTGRES_DB=lily_studio \
            -e POSTGRES_USER=lily_user \
            -e POSTGRES_PASSWORD=lily123 \
            postgres:13

          # Wait until Postgres is ready
          TIMEOUT=30
          SECONDS=0
          until docker exec lily-db pg_isready -U lily_user -d lily_studio; do
            echo "Waiting for Postgres..."
            sleep 2
            SECONDS=$((SECONDS+2))
            if [ $SECONDS -ge $TIMEOUT ]; then
              echo "Postgres did not start in $TIMEOUT seconds"
              docker logs lily-db
              exit 1
            fi
          done
          echo "Postgres is ready"

      # Run app container
      - name: Run Node App
        run: |
          docker run -d -p 3000:3000 --name test-app --network lily-net \
            -e DB_HOST=lily-db \
            -e DB_PORT=5432 \
            -e DB_NAME=lily_studio \
            -e DB_USER=lily_user \
            -e DB_PASSWORD=lily123 \
            lily-designer-studio:latest

          # Retry health check
          SUCCESS=0
          for i in {1..10}; do
            if curl -f http://localhost:3000/api/health; then
              echo "✅ Health check passed"
              SUCCESS=1
              break
            else
              echo "Waiting for app..."
              sleep 2
            fi
          done

          if [ $SUCCESS -ne 1 ]; then
            echo "❌ Health check failed. Dumping logs..."
            echo "---- App logs ----"
            docker logs test-app || echo "No logs"
            echo "---- PostgreSQL logs ----"
            docker logs lily-db || echo "No logs"
            docker stop test-app || true
            docker stop lily-db || true
            docker network rm lily-net || true
            exit 1
          fi

          # Cleanup
          docker stop test-app
          docker stop lily-db
          docker network rm lily-net
