<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blocked Slots - Lily Admin</title>
    <link rel="stylesheet" href="/admin/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .calendar-navigation {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .calendar-navigation button {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .calendar-day {
            min-height: 120px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .calendar-day:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
        }
        
        .calendar-day.empty {
            background: #f8f9fa;
            cursor: default;
        }
        
        .calendar-day.empty:hover {
            transform: none;
            background: #f8f9fa;
        }
        
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            color: #495057;
        }
        
        .day-slots {
            font-size: 12px;
        }
        
        .slot-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .slot-status.available {
            background: #28a745;
        }
        
        .slot-status.booked {
            background: #ffc107;
        }
        
        .slot-status.blocked {
            background: #dc3545;
        }
        
        .block-form {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .time-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .block-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .block-type-btn {
            padding: 10px 20px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .block-type-btn.active {
            border-color: #3498db;
            background: #e3f2fd;
            color: #3498db;
        }
        
        .recurring-options {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        
        .days-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .day-checkbox {
            display: none;
        }
        
        .day-label {
            padding: 8px 15px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .day-checkbox:checked + .day-label {
            border-color: #3498db;
            background: #3498db;
            color: white;
        }
        
        .blocked-slots-list {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-top: 30px;
        }
        
        .block-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .block-item:last-child {
            border-bottom: none;
        }
        
        .block-info h4 {
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .block-info p {
            color: #7f8c8d;
            font-size: 14px;
            margin: 0;
        }
        
        .block-actions {
            display: flex;
            gap: 10px;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            font-size: 14px;
            color: #6c757d;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-crown"></i> Lily Admin</h2>
                <p>No Login Required</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin" class="nav-item">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="/admin#photosPage" class="nav-item">
                    <i class="fas fa-images"></i> Photo Manager
                </a>
                <a href="/admin#appointmentsPage" class="nav-item">
                    <i class="fas fa-calendar-alt"></i> Appointments
                </a>
                <a href="/admin#uploadPage" class="nav-item">
                    <i class="fas fa-upload"></i> Upload Photos
                </a>
                <a href="#" class="nav-item active">
                    <i class="fas fa-ban"></i> Blocked Slots
                </a>
                <a href="/admin#backupPage" class="nav-item">
                    <i class="fas fa-database"></i> Backup
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="topbar">
                <div class="topbar-left">
                    <h1>Blocked Slots Management</h1>
                </div>
                <div class="topbar-right">
                    <span class="server-status">
                        <i class="fas fa-circle" style="color: #4CAF50;"></i>
                        <span>Server Online</span>
                    </span>
                </div>
            </div>

            <!-- Calendar View -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <h2 id="currentMonth">December 2024</h2>
                    <div class="calendar-navigation">
                        <button onclick="changeMonth(-1)">
                            <i class="fas fa-chevron-left"></i> Prev
                        </button>
                        <button onclick="goToToday()">Today</button>
                        <button onclick="changeMonth(1)">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="calendar-grid" id="calendarDays">
                    <!-- Calendar will be populated by JavaScript -->
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <span class="slot-status available"></span>
                        <span>Available</span>
                    </div>
                    <div class="legend-item">
                        <span class="slot-status booked"></span>
                        <span>Booked</span>
                    </div>
                    <div class="legend-item">
                        <span class="slot-status blocked"></span>
                        <span>Blocked</span>
                    </div>
                </div>
            </div>

            <!-- Block Form -->
            <div class="block-form">
                <h2>Block Time Slots</h2>
                
                <form id="blockForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="blockDate">Date</label>
                            <input type="date" id="blockDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Block Type</label>
                            <div class="block-type-selector">
                                <button type="button" class="block-type-btn active" data-type="single">
                                    Single Day
                                </button>
                                <button type="button" class="block-type-btn" data-type="range">
                                    Date Range
                                </button>
                                <button type="button" class="block-type-btn" data-type="weekly">
                                    Weekly Recurring
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row" id="singleDayFields">
                        <div class="form-group">
                            <label for="allDay">
                                <input type="checkbox" id="allDay"> All Day
                            </label>
                        </div>
                        
                        <div class="form-group" id="timeFields">
                            <label>Time Range</label>
                            <div class="time-inputs">
                                <input type="time" id="startTime" value="09:00">
                                <span>to</span>
                                <input type="time" id="endTime" value="17:00">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row" id="rangeFields" style="display: none;">
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="date" id="endDate">
                        </div>
                    </div>
                    
                    <div class="recurring-options" id="weeklyFields">
                        <h4>Weekly Recurring</h4>
                        <div class="days-selector">
                            <input type="checkbox" id="day0" class="day-checkbox" value="0">
                            <label for="day0" class="day-label">Sun</label>
                            
                            <input type="checkbox" id="day1" class="day-checkbox" value="1">
                            <label for="day1" class="day-label">Mon</label>
                            
                            <input type="checkbox" id="day2" class="day-checkbox" value="2">
                            <label for="day2" class="day-label">Tue</label>
                            
                            <input type="checkbox" id="day3" class="day-checkbox" value="3">
                            <label for="day3" class="day-label">Wed</label>
                            
                            <input type="checkbox" id="day4" class="day-checkbox" value="4">
                            <label for="day4" class="day-label">Thu</label>
                            
                            <input type="checkbox" id="day5" class="day-checkbox" value="5">
                            <label for="day5" class="day-label">Fri</label>
                            
                            <input type="checkbox" id="day6" class="day-checkbox" value="6">
                            <label for="day6" class="day-label">Sat</label>
                        </div>
                        
                        <div class="form-group">
                            <label for="weeksCount">Repeat for (weeks):</label>
                            <input type="number" id="weeksCount" min="1" max="52" value="4">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="blockReason">Reason (optional)</label>
                        <input type="text" id="blockReason" placeholder="e.g., Holiday, Maintenance, Personal">
                    </div>
                    
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-ban"></i> Block Selected Time(s)
                    </button>
                </form>
            </div>

            <!-- Blocked Slots List -->
            <div class="blocked-slots-list">
                <h2>Current Blocked Slots</h2>
                <div id="blockedSlotsList">
                    <!-- Blocked slots will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        let currentDate = new Date();
        
        class BlockedSlotsManager {
            constructor() {
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.loadCalendar();
                this.loadBlockedSlots();
                
                // Set default date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('blockDate').value = today;
                
                // Set end date to 7 days from today
                const endDate = new Date();
                endDate.setDate(endDate.getDate() + 7);
                document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            }
            
            bindEvents() {
                // Block type selection
                document.querySelectorAll('.block-type-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.block-type-btn').forEach(b => 
                            b.classList.remove('active')
                        );
                        btn.classList.add('active');
                        
                        const type = btn.dataset.type;
                        this.showBlockTypeFields(type);
                    });
                });
                
                // All day checkbox
                document.getElementById('allDay').addEventListener('change', (e) => {
                    document.getElementById('timeFields').style.display = 
                        e.target.checked ? 'none' : 'block';
                });
                
                // Block form submission
                document.getElementById('blockForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createBlock();
                });
            }
            
            showBlockTypeFields(type) {
                // Hide all fields
                document.getElementById('singleDayFields').style.display = 'none';
                document.getElementById('rangeFields').style.display = 'none';
                document.getElementById('weeklyFields').style.display = 'none';
                
                // Show relevant fields
                if (type === 'single') {
                    document.getElementById('singleDayFields').style.display = 'block';
                } else if (type === 'range') {
                    document.getElementById('singleDayFields').style.display = 'block';
                    document.getElementById('rangeFields').style.display = 'block';
                } else if (type === 'weekly') {
                    document.getElementById('singleDayFields').style.display = 'block';
                    document.getElementById('weeklyFields').style.display = 'block';
                }
            }
            
            async loadCalendar() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                
                // Update month header
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];
                document.getElementById('currentMonth').textContent = 
                    `${monthNames[month]} ${year}`;
                
                // Get first day of month
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                
                // Create calendar grid
                const calendarGrid = document.getElementById('calendarDays');
                calendarGrid.innerHTML = '';
                
                // Add day headers
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayNames.forEach(day => {
                    const header = document.createElement('div');
                    header.className = 'calendar-day-header';
                    header.textContent = day;
                    calendarGrid.appendChild(header);
                });
                
                // Add empty cells for days before first day of month
                for (let i = 0; i < firstDay.getDay(); i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day empty';
                    calendarGrid.appendChild(emptyDay);
                }
                
                // Add days of month
                const daysInMonth = lastDay.getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    dayElement.dataset.date = dateStr;
                    
                    dayElement.innerHTML = `
                        <div class="day-number">${day}</div>
                        <div class="day-slots" id="slots-${dateStr}">
                            Loading...
                        </div>
                    `;
                    
                    dayElement.addEventListener('click', () => {
                        this.selectDate(dateStr);
                    });
                    
                    calendarGrid.appendChild(dayElement);
                    
                    // Load availability for this day
                    this.loadDayAvailability(dateStr);
                }
            }
            
            async loadDayAvailability(date) {
                try {
                    const response = await fetch(`/api/admin/available-slots/${date}`);
                    const data = await response.json();
                    
                    const slotsElement = document.getElementById(`slots-${date}`);
                    if (!slotsElement) return;
                    
                    if (data.error) {
                        slotsElement.innerHTML = '<span style="color: #dc3545;">Error</span>';
                        return;
                    }
                    
                    const availableCount = data.availableSlots.length;
                    const bookedCount = data.bookedSlots.length;
                    const blockedCount = data.allSlots.length - availableCount - bookedCount;
                    
                    slotsElement.innerHTML = `
                        <div>
                            <span class="slot-status available"></span>
                            ${availableCount} available
                        </div>
                        <div>
                            <span class="slot-status booked"></span>
                            ${bookedCount} booked
                        </div>
                        <div>
                            <span class="slot-status blocked"></span>
                            ${blockedCount} blocked
                        </div>
                    `;
                    
                    // Add visual indicator if day has blocks
                    const dayElement = slotsElement.closest('.calendar-day');
                    if (blockedCount > 0) {
                        dayElement.style.borderColor = '#dc3545';
                        dayElement.style.backgroundColor = '#fff5f5';
                    } else if (bookedCount > 0) {
                        dayElement.style.borderColor = '#ffc107';
                        dayElement.style.backgroundColor = '#fffcf0';
                    }
                } catch (error) {
                    console.error('Error loading day availability:', error);
                }
            }
            
            async loadBlockedSlots() {
                try {
                    const response = await fetch('/api/admin/blocked-slots');
                    const data = await response.json();
                    
                    const listElement = document.getElementById('blockedSlotsList');
                    if (!listElement) return;
                    
                    if (data.error || !data.success) {
                        listElement.innerHTML = '<p>Error loading blocked slots</p>';
                        return;
                    }
                    
                    if (data.blockedSlots.length === 0) {
                        listElement.innerHTML = '<p>No blocked slots found</p>';
                        return;
                    }
                    
                    listElement.innerHTML = '';
                    
                    data.blockedSlots.forEach(slot => {
                        const blockItem = document.createElement('div');
                        blockItem.className = 'block-item';
                        
                        const date = new Date(slot.date).toLocaleDateString();
                        let timeInfo = '';
                        
                        if (slot.all_day) {
                            timeInfo = 'All Day';
                        } else if (slot.start_time && slot.end_time) {
                            timeInfo = `${slot.start_time.substring(0, 5)} - ${slot.end_time.substring(0, 5)}`;
                        } else if (slot.start_time) {
                            timeInfo = `From ${slot.start_time.substring(0, 5)}`;
                        } else if (slot.end_time) {
                            timeInfo = `Until ${slot.end_time.substring(0, 5)}`;
                        }
                        
                        blockItem.innerHTML = `
                            <div class="block-info">
                                <h4>${date} â€¢ ${timeInfo}</h4>
                                <p>${slot.reason || 'No reason provided'}</p>
                                <p><small>Type: ${slot.block_type}</small></p>
                            </div>
                            <div class="block-actions">
                                <button class="btn-secondary" onclick="blockManager.deleteBlock(${slot.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        `;
                        
                        listElement.appendChild(blockItem);
                    });
                } catch (error) {
                    console.error('Error loading blocked slots:', error);
                }
            }
            
            selectDate(date) {
                document.getElementById('blockDate').value = date;
                
                // Scroll to form
                document.querySelector('.block-form').scrollIntoView({ 
                    behavior: 'smooth' 
                });
            }
            
            async createBlock() {
                const blockType = document.querySelector('.block-type-btn.active').dataset.type;
                const date = document.getElementById('blockDate').value;
                const allDay = document.getElementById('allDay').checked;
                const startTime = document.getElementById('startTime').value;
                const endTime = document.getElementById('endTime').value;
                const reason = document.getElementById('blockReason').value;
                const endDate = document.getElementById('endDate').value;
                
                // Prepare data
                const blockData = {
                    date: date,
                    all_day: allDay,
                    reason: reason,
                    block_type: blockType
                };
                
                if (!allDay) {
                    blockData.start_time = startTime + ':00';
                    blockData.end_time = endTime + ':00';
                }
                
                if (blockType === 'range' && endDate) {
                    blockData.end_date = endDate;
                }
                
                if (blockType === 'weekly') {
                    const days = [];
                    document.querySelectorAll('.day-checkbox:checked').forEach(cb => {
                        days.push(parseInt(cb.value));
                    });
                    
                    if (days.length === 0) {
                        alert('Please select at least one day for weekly recurring block');
                        return;
                    }
                    
                    const weeks = parseInt(document.getElementById('weeksCount').value) || 4;
                    blockData.recurring_pattern = {
                        type: 'weekly',
                        days: days,
                        weeks: weeks
                    };
                }
                
                try {
                    const response = await fetch('/api/admin/blocked-slots', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(blockData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert(result.message);
                        this.loadCalendar();
                        this.loadBlockedSlots();
                        document.getElementById('blockForm').reset();
                    } else {
                        alert('Error: ' + (result.error || 'Failed to create block'));
                    }
                } catch (error) {
                    console.error('Error creating block:', error);
                    alert('Failed to create block');
                }
            }
            
            async deleteBlock(id) {
                if (!confirm('Are you sure you want to delete this block?')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/admin/blocked-slots/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Block deleted successfully');
                        this.loadCalendar();
                        this.loadBlockedSlots();
                    } else {
                        alert('Error: ' + (result.error || 'Failed to delete block'));
                    }
                } catch (error) {
                    console.error('Error deleting block:', error);
                    alert('Failed to delete block');
                }
            }
            
            changeMonth(delta) {
                currentDate.setMonth(currentDate.getMonth() + delta);
                this.loadCalendar();
            }
            
            goToToday() {
                currentDate = new Date();
                this.loadCalendar();
            }
        }
        
        // Initialize
        let blockManager;
        document.addEventListener('DOMContentLoaded', () => {
            blockManager = new BlockedSlotsManager();
        });
        
        // Global functions for buttons
        function changeMonth(delta) {
            blockManager.changeMonth(delta);
        }
        
        function goToToday() {
            blockManager.goToToday();
        }
    </script>
</body>
</html>